---
import { FIGHTERS } from '@/consts/fighters'
import { COMBATS } from '@/consts/combats'
import { countries } from '@/consts/countries'
import Layout from '@/layouts/Layout.astro'
import { fixedTitle } from '@/consts/pageTitles'

const { id } = Astro.params

const fighter = FIGHTERS.find((fighter) => fighter.id === id)
if (!fighter) return Astro.redirect('/404')

const birthDate = fighter.birthDate.toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
})
//Buscamos el oponente
const opponent = FIGHTERS.find(f => f.id === fighter.versus)
// Buscar el combate correspondiente
const combat = opponent ? COMBATS.find(
  (c) => c.fighters.includes(fighter.id) && c.fighters.includes(opponent.id),
) : null;
const combatId = combat?.id;

// Obtener el país del luchador y del oponente
const fighterCountry = countries.find(c => c.id === fighter?.country);
const opponentCountry = countries.find(c => c.id === opponent?.country);

// Obtenemos el nivel y porcentaje de experiencia según la edad del luchador.
const level = Math.floor(fighter.age / 9);
const expPercentage = Math.round((fighter.age % 9) * (100 / 9));
---
<Layout title={`${fighter.name} | ${fixedTitle}`}>
  <section class="relative flex min-h-screen w-full">
    <div class="mask-fade-bottom animate-fade-in absolute inset-0 w-full bg-[url('/images/hero.avif')] bg-cover bg-center opacity-40"></div>
    
    <div class="relative z-10 flex w-full flex-col items-center justify-center gap-8 px-4 pt-24 lg:flex-row lg:items-start lg:pt-32">
      <!-- Imagen grande con hover -->
      <div class="relative flex flex-col w-full lg:w-1/2 items-center gap-8 group">
        <img
          src={`/images/fighters/big/${id}.webp`}
          alt={fighter.name}
          class="h-full w-full object-contain transition-all duration-700 hover:brightness-130 animate-fade-in border-4 border-theme-turquoise rounded-lg hover:shadow-2xl hover:shadow-theme-turquoise"
        />
        <!-- Redes sociales al hacer hover -->
        <div class="absolute top-4 right-4 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
          {
            (fighter.socials || [])?.map(({ url, image, name, label }) => (
              <a
                href={url}
                target="_blank"
                aria-label={label ?? name}
                class="hover:scale-125 transition flex items-center justify-center"
              >
                <image.logo class="text-black" />
              </a>
            ))
          }
        </div>
        <!-- Cuadro del rival -->
        {opponent && (
          <div class="relative w-full p-6 bg-gradient-to-r from-theme-tickle-me-pink to-theme-turquoise rounded-lg shadow-2xl text-white text-center group transition-all duration-500 hover:brightness-110 hover:shadow-2xl border-4 border-theme-turquoise rounded-lg hover:shadow-theme-turquoise">
            <!-- Contenedor horizontal -->
            <div class="flex items-center justify-center gap-8">
              <!-- Luchador -->
              <div>
                <div class="text-2xl font-bold">{fighter.name}</div>
                <div class="flex justify-center gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  {
                    (fighter.socials || [])?.map(({ url, image, name, label }) => (
                      <a
                        href={url}
                        target="_blank"
                        aria-label={label ?? name}
                        class="hover:scale-125 transition flex items-center justify-center"
                      >
                        <image.logo class="w-6 h-6 text-white" />
                      </a>
                    ))
                  }
                </div>
                <!-- Bandera del luchador -->
                {fighterCountry && (
                  <div class="flex items-center justify-center gap-2 mt-2">
                    <img
                      src={fighterCountry.image.src}
                      alt={`Bandera de ${fighterCountry.name}`}
                      class="h-6 w-auto rounded"
                    />
                    <span>{fighterCountry.name}</span>
                  </div>
                )}
              </div>
        
              <!-- VS -->
              <div class="text-3xl font-bold">
                <a href={`/combates/${combatId}`} class="hover:underline">
                  VS
                </a>
              </div>
        
              <!-- Rival -->
              <div>
                <a
                  href={`/luchador/${opponent.id}`}
                  class="group transform transition-all hover:brightness-125 hover:shadow-2xl"
                >
                  <div class="text-2xl font-bold">{opponent.name}</div>
                  <div class="flex justify-center gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                    {
                      (opponent.socials || [])?.map(({ url, image, name, label }) => (
                        <a
                          href={url}
                          target="_blank"
                          aria-label={label ?? name}
                          class="hover:scale-125 transition flex items-center justify-center"
                        >
                          <image.logo class="w-6 h-6 text-white" />
                        </a>
                      ))
                    }
                  </div>
                  <!-- Bandera del rival -->
                  {opponentCountry && (
                    <div class="flex items-center justify-center gap-2 mt-2">
                      <img
                        src={opponentCountry.image.src}
                        alt={`Bandera de ${opponentCountry.name}`}
                        class="h-6 w-auto rounded"
                      />
                      <span>{opponentCountry.name}</span>
                    </div>
                  )}
                </a>
              </div>
            </div>
          </div>
        )}
      </div>
      
      <!-- Información del luchador -->
      <div class="relative w-full max-w-xl text-white lg:w-1/2 p-6 bg-black/50 rounded-lg animate-fade-in backdrop-blur-md border-2 border-theme-turquoise transition-all duration-500 hover:brightness-125 hover:shadow-2xl border-4 border-theme-turquoise hover:shadow-theme-turquoise">
        <!-- Nombre del luchador y nombre real -->
        <div class="mb-8 flex flex-col items-center">
          <img
            src={`/images/fighters/text/${id}.png`}
            alt={fighter.name}
            class="h-16 w-auto animate-scale-in mb-2"
          />
          <div class="text-2xl font-bold animate-slide-in-right text-center">{fighter.realName}</div>
        </div>
        
        <!-- Bandera del luchador -->
        {fighterCountry && (
          <div class="flex items-center justify-center gap-2 mt-2">
            <img
              src={fighterCountry.image.src}
              alt={`Bandera de ${fighterCountry.name}`}
              class="h-6 w-auto rounded"
            />
            <span>{fighterCountry.name}</span>
          </div>
        )}
        
        <!-- Hoja de personaje -->
        <div class="flex justify-center relative mb-6">

          <img
            src={`/images/fighters/cards/${id}.webp`}
            alt={`${fighter.name} card`}
            class="w-50 rounded-lg shadow-lg mb-6 animate-fade-in justify-center items-center"
          />
        </div>
        
        <!-- Redes sociales -->
        <div class="absolute top-25 right-4 flex flex-col gap-2 group transition-opacity duration-500">
          {
            (fighter.socials || [])?.map(({ url, image, name, label }) => (
              <a
                href={url}
                target="_blank"
                aria-label={label ?? name}
                class="opacity-0 group-hover:opacity-100 hover:scale-125 transition flex items-center justify-center"
              >
                <image.logo class="text-white" />
              </a>
            ))
          }
        </div>
        
        <!-- Estadísticas -->
        <div class="grid grid-cols-2 gap-4">
          <div class="stat-item"><span class="text-sm text-gray-400">Edad</span> <span class="text-lg">{fighter.age} años</span></div>
          <div class="stat-item"><span class="text-sm text-gray-400">Altura</span> <span class="text-lg">{fighter.height}m</span></div>
          <div class="stat-item"><span class="text-sm text-gray-400">Peso</span> <span class="text-lg">{fighter.weight}kg</span></div>
          <div class="stat-item"><span class="text-sm text-gray-400">Ciudad</span> <span class="text-lg">{fighter.city}</span></div>
        </div>
        
        <div class="mt-4">
          <div class="text-sm text-gray-400">Fecha de nacimiento</div>
          <div class="text-lg">{birthDate}</div>
        </div>
        
        <!-- Nivel y experiencia -->
        <div class="mt-6 relative">
          <div class="text-sm text-gray-400">Nivel</div>
          <div class="flex items-center gap-2 relative group">
            <!-- Nivel con subrayado -->
            <span class="text-lg font-bold underline decoration-dotted decoration-theme-turquoise cursor-pointer">
              {level}
            </span>
            <!-- Ícono de información -->
            <span class="text-theme-turquoise cursor-pointer group-hover:text-white transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 10-1.5 0v.5a.75.75 0 001.5 0v-.5zm-.75 2.5a.75.75 0 00-.75.75v4a.75.75 0 001.5 0v-4a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
              </svg>
            </span>
            <!-- Tooltip -->
            <div class="absolute left-1/2 -translate-x-1/2 mt-2 w-max bg-black text-white text-xs rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 shadow-lg">
              Fórmula: Math.floor(edad / 9)
            </div>
          </div>
          <div class="w-full bg-gray-700 h-4 rounded-lg overflow-hidden mt-1">
            <div class="h-full bg-theme-tickle-me-pink" style={{ width: `${expPercentage}%` }}></div>
          </div>
          <div class="text-sm text-gray-400 mt-1">Exp: {expPercentage}%</div>
        </div>
        
        <!-- Atributos y habilidades -->
        <div class="mt-6">
          <div class="text-lg font-bold">Atributos</div>
          <div class="grid grid-cols-2 gap-4 mt-2">
            {Object.entries(fighter.attributes).map(([name, level]) => (
              <div class="flex flex-col">
                <span class="text-sm text-gray-400 capitalize">{name}</span>
                <div class="w-full bg-gray-700 h-4 rounded-lg overflow-hidden">
                  <div class="h-full bg-theme-turquoise" style={{ width: `${level * 10}%` }}></div>
                </div>
                <span class="text-sm text-gray-400 mt-1">Nivel: {level}</span>
              </div>
            ))}
          </div>
        </div>
                
        <div class="mt-6">
          <div class="text-lg font-bold">Habilidades</div>
          <div class="grid grid-cols-2 gap-4 mt-2">
            {Object.entries(fighter.skills).map(([name, level]) => (
              <div class="flex flex-col">
                <span class="text-sm text-gray-400 capitalize">{name.replace('_', ' ')}</span>
                <div class="w-full bg-gray-700 h-4 rounded-lg overflow-hidden">
                  <div class="h-full bg-theme-tickle-me-pink" style={{ width: `${level * 10}%` }}></div>
                </div>
                <span class="text-sm text-gray-400 mt-1">Nivel: {level}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  .stat-item {
    animation: fadeIn 0.5s ease-out forwards;
    opacity: 0;
  }

  .stat-item:nth-child(1) { animation-delay: 0.1s; }
  .stat-item:nth-child(2) { animation-delay: 0.2s; }
  .stat-item:nth-child(3) { animation-delay: 0.3s; }
  .stat-item:nth-child(4) { animation-delay: 0.4s; }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }


</style>